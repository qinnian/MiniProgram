# parser-wxapp
微信小程序富文本解析插件
## 使用方法 ##
- 安装 
  
  ```npm
  npm install parser-wxapp
  ```
- 使用
  
  ```javascript
  const parser=require('parser-wxapp');
  var html="<div>Hello World!</div>";
  parser(html).then(res=>{
    console.log(res);
  }).catch(err=>{
    console.error(err);
  })
  /*
  (async ()=>{
    res=await parser(html);   
  })();
  */
  ```
  ```json
  {
    "title": "",
    "nodes": [{
      "name": "div",
      "attrs": {},
      "children": [{
        "text": "Hello World!",
        "type": "text"
      }]
    }],
    "imgList": []
  }
  ```
- 参数
  
  | 参数 | 类型 | 必填 | 默认值 | 说明 |
  |:---:|:---:|:---:|:---:|:---:|
  | html | String | 是 | | 需要解析的html字符串 |
  | mode | String | 否 | html | 解析模式，支持的有html, website, file, markdown(md) |
  | options | Object | 否 |  | 解析设置，具体见下方说明 |
- 解析模式
  - `html`模式：输入一个`html`字符串
  - `website`模式：输入一个网址，必须以`http://`或`https://`开头
  - `markdown`模式：输入`markdown`字符串，支持表格、代码高亮等  
  - `file`模式：输入文件路径，自动打开并解析（仅支持`html`和`md`文件）  
  
- 解析设置
  - `styles`：代码高亮风格，默认`default`
  - `tagStyle`：标签的默认样式，如`{body:"margin:5px"}`
  - `domain`：主域名，当多媒体标签的`src`属性是`/`开头的时，会自动与主域名拼接成完整的地址，避免无法在小程序上显示（解析模式为`website`时会自动获取`domain`）
  - `autohighlight`：是否自动对`pre`标签内的内容进行高亮处理，默认`true`  
  - `engine`：打开网址的引擎（解析模式为`website`以及获取`iframe`中的内容时使用）
  
    | 名称 | 速度 | 说明 |
    |:---:|:---:|:---:|
    | default | 快 | 使用`node.js`自带的`http`和`https`模块获取（默认），但`js`中动态加载的内容将被忽略 |
    | puppeteer | 慢 | 使用`puppeteer`加载（支持动态页面），使用前需要安装本地依赖`npm i puppeteer` |
    | phantom | 慢 | 使用`phantom`加载（支持动态页面），使用前需要安装本地依赖`npm i phantom` |
  - `maxDepth`：前端显示时的最大递归深度，为0或负数时代表不限制（默认为0）。层数超过限制时，会直接使用`rich-text`显示而不再递归，可能导致图片不能预览，链接无法点击，视频和音频无法显示等问题；但过深的深度可能导致渲染时间较长；对于复杂的内容可以适当进行限制（需与前端组件[`Parser`](https://github.com/jin-yufeng/Parser)配合）
- 返回值  
  一个形如`{title: "String", "nodes":[Array], "imgList": [Array], "videoNum": Number}`的结构体，其中`title`为页面标题（title标签中的值），`nodes`为节点数组（可以作为`rich-text`组件的`nodes`参数），`imgList`是所有图片地址的数组，`videoNum`是视频数量

- 与前端`Parser`组件配合  
  本插件建议与前端轻量级（28.1KB）组件包[`Parser`](https://github.com/jin-yufeng/Parser)配合使用，返回值可以直接作为`Parser`组件的参数，与该插件配合可以实现图片预览，链接点击，视频显示等一些`rich-text`组件无法实现的功能。  
  [GitHub地址](https://github.com/jin-yufeng/Parser)  
**注意：本包需要node.js v7.6.0以上运行环境，不能直接在小程序前端使用，建议部署在云函数或服务器上，将解析结果返回前端显示**
## 功能介绍 ##
1. 支持解析和匹配`style`标签中的样式  
   支持以下模式的匹配：

   | 模式 | 匹配的标签 | 说明 |
   |:---:|:---:|:---:|
   | .demo | &lt;element class="demo"&gt; | 按class匹配 |
   | #demo | &lt;element id="demo"&gt; | 按id匹配 |
   | body | &lt;body&gt; | 按标签名匹配 |
   | * | 所有 | 通配符 |
   | .demo1,.demo2 | &lt;element class="demo1"&gt;<br />&lt;element class="demo2"&gt; | 多个并列 |
   | .demo1.demo2 | &lt;element class="demo1 demo2"&gt; | 一层多个 |
   | .demo1 .demo2 | &lt;element class="demo1"&gt;<br />...<br />&ensp;&ensp;&ensp;&ensp;&lt;element class="demo2"&gt; | 后代选择器 |
   | .demo1>.demo2 | &lt;element class="demo1"&gt;<br />&ensp;&ensp;&ensp;&ensp;&lt;element class="demo2"&gt; | 子选择器 |
   
   示例：  
   ```html
   <style>
   .demo1 .demo2{
     text-align:center;
   }
   </style>
   <div class="demo1">
     <div class="demo2">Hello World!</div>
   </div>
   ```
   ![解析多层style](https://6874-html-foe72-1259071903.tcb.qcloud.la/md/md1.png?sign=b741cd402869a59f92a21115d72fee01&t=1561001295)

2. 与前端组件[`Parser`](https://github.com/jin-yufeng/Parser)组件相比，增加支持以下标签
   
   | 标签名 | 属性 |
   |:---:|:---:|
   | iframe | src, width, height, marginheight, marginwidth, scrolling |
   | frame | src, width, height, marginheight, marginwidth, scrolling |
   | embed | src |
   | object | data |
   | param | name, value |
   | link | href |

   备注：
   - `iframe`和`frame`标签的`src`仅支持网络地址
   - `embed`和`object`标签仅支持文件类型为视频（`mp4`, `mov`, `m4v`, `3gp`, `avi`, `m3u8`, `webm`），音频（`mp3`, `aac`），图片（`png`, `jpg`, `jpeg`），否则将被忽略
   - `param`标签仅限在`object`标签中使用，否则将被忽略  
   - `link`标签仅支持`css`文件，否则将被忽略  
   
3. 支持解析各类实体  
   支持解析各类`html`实体编码（包括中文）
   ```html
   <span>&#x8FD9;&#x662F;&#x5B9E;&#x4F53;&#x7F16;&#x7801;</span>
   ```
   ![解析实体](https://6874-html-foe72-1259071903.tcb.qcloud.la/md/md2.png?sign=8783df294780e5ee5b5425f28986cb54&t=1561001310)

4. 支持代码高亮  
   支持自动识别语言并进行高亮显示，可自行选择高亮风格(详细可以查看[`highlightjs`官网](https://highlightjs.org/)）  
   示例：
   ```javascript
   var html=`<pre>function demo(){
     console.log("Hello World!");
   }</pre>`
   return await parser(html,'html',{styles:"atom-one-dark"});
   ```
   ![代码高亮](https://6874-html-foe72-1259071903.tcb.qcloud.la/md/md3.png?sign=7c603bd86246c6d2444fc5646e313778&t=1561001324)

5. 支持自动将地址填充完整  
   对于多媒体标签的`src`属性，如果以`/`开头，将自动填充上主域名，避免在小程序中无法显示（可以在`options.domain`中设置，解析模式为`website`时会自动获取）  
   示例：
   ```javascript
   await parser("<img src='/path/demo.jpg'>","html",{domain:"https://example.com"});
   //https://example.com/path/demo.jpg
   ```
6. 支持`website`模式  
   输入网址即可显示其内容，可以选择以下几种引擎（可在`options`中设置）：
   - `default`：适用于静态网页，使用`node.js`自带的`http`和`https`模块获取，速度快，不需要额外安装依赖，但`js`中动态加载的内容都会被忽略
   - `puppeteer`：使用动态网页，使用`Chrome Headless`浏览器加载，速度慢，需要额外安装本地依赖`npm i puppeteer`  
   - `phantom`：适用动态网页，使用`phantom`浏览器加载，速度慢，需要额外安装本地依赖`npm install phantom`
   - 其他：如需使用其他无头浏览器进行加载，可以在加载完成后，将`html`传入进行解析；体验小程序中由于云函数文件大小的限制，无法使用无头浏览器进行加载，只能使用静态模式  
   示例：
   ```javascript
   //静态网页
   await parser("https://example.com","website");
   //动态网页，需提前安装npm i puppeteer
   await parser("https://example.com","website",{engine:"puppeteer"});
   ```
   
7. 支持`markdown`模式  
   支持解析`markdown`，包括表格，代码高亮等
   ```markdown
   # 示例
   | 标题1 | 标题2 |
   |:---:|:---:|
   | 栏目1 | 栏目2 |
   ```
   ![markdown模式](https://6874-html-foe72-1259071903.tcb.qcloud.la/md/md4.png?sign=5ed2727d597e193f853498b43d5168f8&t=1561001337)

6. 支持`file`模式  
   支持输入文件路径即可自动打开文件并进行解析（仅支持`html`文件或`md`文件）  
   示例：
   ```javascript
   return await parser(path.join(__dirname,'demo.html'),"file");
   ```
## 立即体验 ##
点击自定义测试，解析模式选择“后端解析”即可体验  
![立即体验](https://6874-html-foe72-1259071903.tcb.qcloud.la/md/md5.jpg?sign=c7f94d947ac80dee7975db3cc666c92d&t=1561001348)
## 更新日志 ##
- 2019.6.30
  1. `A` 解析设置中增加`autohighlight`属性，可用于控制是否对代码自动高亮处理
- 2019.6.20
  1. `F` 修复了`style`标签中`,`前后有空格时匹配出错的问题
- 2019.6.3
  1. `A` 增加支持`link`标签（仅限`css`）
  2. `U` 增强了`style`标签的解析能力
- 2019.5.31
  1. `F` 修复了部分情况下`style`标签中样式匹配失败的问题
- 2019.5.24
  1. `U` 解析设置中支持设置`maxDepth`来限制前端显示时的最大递归深度
- 2019.5.22
  1. `U` 解析时若存在`video`或`audio`组件既没有`controls`属性也没有`autoplay`属性，会向控制台打印“可能不能播放”的警告
- 2019.5.20
  1. `U` 支持存在多个`source`标签时（仅限用于`video`和`audio`标签中），按顺序进行加载，若前面的链接加载失败，则自动切换加载下一条链接，可用于解决平台差异；避免无法播放（需与前端组件[`Parser`](https://github.com/jin-yufeng/Parser)配合）
  2. `U` `video`标签增加支持`autoplay`和`muted`属性；`audio`标签增加支持`autoplay`属性（需与前端组件[`Parser`](https://github.com/jin-yufeng/Parser)配合）
- 2019.5.17
  1. `U` 支持自动移除`display`为`none`的节点，减小`nodes`数组的大小，加快传输速度和渲染速度
- 2019.5.15
  1. `U` 支持推送页面的腾讯视频`iframe`组件，可以自动获取真实的视频地址
  2. `U` 支持推送页面的`qqmusic`组件，可以自动获取真实的音乐地址；至此基本可以正确解析和显示出推送页面的各类内容
- 2019.5.13
  1. `A` 增加支持`iframe`, `frame`, `embed`, `object`, `param`等标签
  2. `A` 增加支持动态网页模式（使用无头浏览器进行加载）
  3. `U` 支持自动补全多媒体标签的`src`属性（拼接上主域名） 
- 2019.5.12
  1. `A` 增加`file`模式，输入文件路径即可自动打开并解析（仅支持`html`文件或`md`文件）
  2. `F` 修复子选择器`>`前后有空格时无法匹配的问题
- 2019.5.10
  1. `U` 支持播放视频时自动暂停其他视频（需与前端组件[`Parser`](https://github.com/jin-yufeng/Parser)配合）
  2. `U` 当视频数量超过3个时仅加载前3个，其他用图片替代，受到点击时再进行加载和播放（需与前端组件[`Parser`](https://github.com/jin-yufeng/Parser)配合）
  3. `U` 当样式匹配完成后移除节点的`class`和`id`属性，减小了`nodes`数组的大小，加载传输和渲染速度
- 2019.5.6  
  init