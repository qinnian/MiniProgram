const https = require('https');
async function qqVideo(vid) {
    var info = await getInfo('https://vv.video.qq.com/getinfo?otype=json&appver=3.2.19.333&platform=11&defnpayver=1&vid=' + vid);
    var dataJson=info.match(/(\{.*\})/)[1];
    var data = JSON.parse(dataJson);
	var host = data['vl']['vi'][0]['ul']['ui'][0]['url'];
    var fileName = data['vl']['vi'][0]['fn'];
    var fvkey = data['vl']['vi'][0]['fvkey'];
    return (host + fileName + '?vkey=' + fvkey);
}
async function qqMusic(mid) {
    var info = await getInfo('https://mp.weixin.qq.com/mp/qqmusic?action=get_song_info&song_mid=' + mid + '&uin=&key=&pass_ticket=&wxtoken=777&devicetype=&clientversion=&appmsg_token=&x5=0&f=json');
    return info.match(/\\"song_play_url\\"\s*:\s*\\"(.*?)\\"/)[1].replace(/\\/g,'');
}
function getInfo(url) {
    return new Promise(function (resolve, reject) {
        https.get(url, (res) => {
            if (res.statusCode != 200) {
                return reject('Request Failed, statusCode:' + res.statusCode);
            }
            res.setEncoding('utf8');
            let rawData = '';
            res.on('data', (chunk) => { rawData += chunk; });
            res.on('end', () => {
                return resolve(rawData);
            });
        }).on('error', (e) => {
            return reject('Get Error, message:' + e.message);
        });
    })
}
module.exports = {
    qqVideo,
    qqMusic
};